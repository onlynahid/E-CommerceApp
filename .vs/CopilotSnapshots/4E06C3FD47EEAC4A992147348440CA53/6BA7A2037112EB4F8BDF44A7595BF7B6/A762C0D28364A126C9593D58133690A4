using AYYUAZ.APP.Application.Dtos;
using AYYUAZ.APP.Application.Interfaces;
using AYYUAZ.APP.Attributes;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace AYYUAZ.APP.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class OrderController : ControllerBase
    {
        private readonly IOrderService _orderService;

        public OrderController(IOrderService orderService)
        {
            _orderService = orderService;
        }

        [HttpGet]
        [Authorize]
        public async Task<ActionResult<IEnumerable<OrderDto>>> GetAllOrders()
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can view all orders");

            var orders = await _orderService.GetAllOrdersAsync();
            return Ok(orders);
        }

        [HttpGet("{id}")]
        [Authorize]
        public async Task<ActionResult<OrderDto>> GetOrderById(int id)
        {
            var order = await _orderService.GetOrderByIdAsync(id);
            if (order == null)
            {
                return NotFound($"Order with ID {id} not found.");
            }
            return Ok(order);
        }

        [HttpPost]
        public async Task<ActionResult<OrderDto>> CreateOrder([FromBody] CreateOrderDto createOrderDto)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            try
            {
                var order = await _orderService.CreateOrderAsync(createOrderDto);
                return CreatedAtAction(nameof(GetOrderById), new { id = order.Id }, order);
            }
            catch (Exception ex)
            {
                return BadRequest(new { message = ex.Message });
            }
        }

        [HttpPut("{id}")]
        [Authorize]
        public async Task<ActionResult<OrderDto>> UpdateOrder(int id, [FromBody] UpdateOrderDto updateOrderDto)
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can update orders");

            if (id != updateOrderDto.Id)
            {
                return BadRequest("Order ID mismatch.");
            }

            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            try
            {
                var order = await _orderService.UpdateOrderAsync(updateOrderDto);
                if (order == null)
                {
                    return NotFound($"Order with ID {id} not found.");
                }
                return Ok(order);
            }
            catch (Exception ex)
            {
                return BadRequest(new { message = ex.Message });
            }
        }

        [HttpDelete("{id}")]
        [Authorize]
        public async Task<ActionResult> DeleteOrder(int id)
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can delete orders");

            var result = await _orderService.DeleteOrderAsync(id);
            if (!result)
            {
                return NotFound($"Order with ID {id} not found.");
            }
            return NoContent();
        }

        [HttpGet("customer/{customerName}")]
        [Authorize]
        public async Task<ActionResult<IEnumerable<OrderDto>>> GetOrdersByCustomer(string customerName)
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can view orders by customer");

            if (string.IsNullOrEmpty(customerName))
            {
                return BadRequest("Customer name cannot be empty.");
            }

            var orders = await _orderService.GetOrdersByCustomerAsync(customerName);
            return Ok(orders);
        }

        [HttpGet("search")]
        [Authorize]
        public async Task<ActionResult<IEnumerable<OrderDto>>> SearchOrders([FromQuery] string searchTerm)
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can search orders");

            if (string.IsNullOrEmpty(searchTerm))
            {
                return BadRequest("Search term cannot be empty.");
            }

            var orders = await _orderService.SearchOrdersAsync(searchTerm);
            return Ok(orders);
        }

        [HttpGet("paged")]
        [Authorize]
        public async Task<ActionResult<object>> GetOrdersWithPagination([FromQuery] int page = 1, [FromQuery] int pageSize = 10)
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can view orders with pagination");

            if (page < 1 || pageSize < 1)
            {
                return BadRequest("Page and page size must be greater than 0.");
            }

            var orders = await _orderService.GetOrdersWithPaginationAsync(page, pageSize);
            var totalCount = await _orderService.GetOrderCountAsync();
            
            return Ok(new
            {
                orders,
                totalCount,
                currentPage = page,
                pageSize,
                totalPages = (int)Math.Ceiling((double)totalCount / pageSize)
            });
        }

        [HttpGet("recent")]
        [Authorize]
        public async Task<ActionResult<IEnumerable<OrderDto>>> GetRecentOrders([FromQuery] int count = 10)
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can view recent orders");

            var orders = await _orderService.GetRecentOrdersAsync(count);
            return Ok(orders);
        }

        [HttpGet("statistics/average-order-value")]
        [Authorize]
        public async Task<ActionResult<decimal>> GetAverageOrderValue()
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can view order statistics");

            var averageValue = await _orderService.GetAverageOrderValueAsync();
            return Ok(new { averageOrderValue = averageValue });
        }

        [HttpGet("count")]
        [Authorize]
        public async Task<ActionResult<int>> GetOrderCount()
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can view order count");

            var count = await _orderService.GetOrderCountAsync();
            return Ok(count);
        }

        [HttpGet("{id}/with-items")]
        [Authorize]
        public async Task<ActionResult<OrderDto>> GetOrderWithItems(int id)
        {
            var order = await _orderService.GetOrderWithItemsAsync(id);
            if (order == null)
            {
                return NotFound($"Order with ID {id} not found.");
            }
            return Ok(order);
        }

        [HttpGet("with-items")]
        [Authorize]
        public async Task<ActionResult<IEnumerable<OrderDto>>> GetOrdersWithItems()
        {
            var isAdmin = User.Claims.FirstOrDefault(c => c.Type == "isAdmin")?.Value;
            if (isAdmin != "True")
                return Forbid("Only admin users can view orders with items");

            var orders = await _orderService.GetOrdersWithItemsAsync();
            return Ok(orders);
        }
    }
}