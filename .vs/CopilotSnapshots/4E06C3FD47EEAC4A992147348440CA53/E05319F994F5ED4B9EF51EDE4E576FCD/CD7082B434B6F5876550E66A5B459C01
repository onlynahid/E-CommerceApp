using AYYUAZ.APP.Application.Dtos;
using AYYUAZ.APP.Application.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.ComponentModel.DataAnnotations;

namespace AYYUAZ.APP.AdminController
{
    [Route("api/[controller]")]
    [ApiController]
    public class AdminProductController : ControllerBase
    {
        private readonly IProductService _productService;
        private readonly ILogger<AdminProductController> _logger;

        public AdminProductController(IProductService productService, ILogger<AdminProductController> logger)
        {
            _productService = productService;
            _logger = logger;
        }

        /// <summary>
        /// Create a new product (Admin only)
        /// </summary>
        [HttpPost]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<ProductDto>> CreateProduct([FromForm] CreateProductDto createProductDto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ModelState);
                }

                var product = await _productService.CreateProductAsync(createProductDto);
                return CreatedAtAction(nameof(GetProductById), new { id = product.Id }, product);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating product");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Update an existing product (Admin only)
        /// </summary>
        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<ProductDto>> UpdateProduct(int id, [FromForm] UpdateProductDto updateProductDto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ModelState);
                }

                var product = await _productService.UpdateProductAsync(id, updateProductDto);
                return Ok(product);
            }
            catch (KeyNotFoundException)
            {
                return NotFound(new { message = $"Product with ID {id} not found." });
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating product with ID {ProductId}", id);
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Delete a product (Admin only)
        /// </summary>
        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult> DeleteProduct(int id)
        {
            try
            {
                var result = await _productService.DeleteProductAsync(id);
                if (!result)
                {
                    return NotFound(new { message = $"Product with ID {id} not found." });
                }

                return NoContent();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting product with ID {ProductId}", id);
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get product by ID
        /// </summary>
        [HttpGet("{id}")]
        public async Task<ActionResult<ProductDto>> GetProductById(int id)
        {
            try
            {
                var product = await _productService.GetProductByIdAsync(id);
                return Ok(product);
            }
            catch (KeyNotFoundException)
            {
                return NotFound(new { message = $"Product with ID {id} not found." });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting product with ID {ProductId}", id);
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get all products with admin view
        /// </summary>
        [HttpGet]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetAllProducts()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                return Ok(products);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all products");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get products with pagination and admin info
        /// </summary>
        [HttpGet("paged")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<object>> GetProductsWithPagination([FromQuery] int page = 1, [FromQuery] int pageSize = 10)
        {
            try
            {
                if (page < 1 || pageSize < 1)
                {
                    return BadRequest(new { message = "Page and page size must be greater than 0." });
                }

                var products = await _productService.GetProductsWithPaginationAsync(page, pageSize);
                var totalCount = await _productService.GetProductCountAsync();

                return Ok(new
                {
                    products,
                    totalCount,
                    currentPage = page,
                    pageSize,
                    totalPages = (int)Math.Ceiling((double)totalCount / pageSize),
                    hasNextPage = page < (int)Math.Ceiling((double)totalCount / pageSize),
                    hasPreviousPage = page > 1
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting paginated products");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get products by category (Admin view)
        /// </summary>
        [HttpGet("category/{categoryId}")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsByCategory(int categoryId)
        {
            try
            {
                var products = await _productService.GetProductsByCategoryAsync(categoryId);
                var count = await _productService.GetProductCountByCategoryAsync(categoryId);

                return Ok(new
                {
                    products,
                    categoryId,
                    totalCount = count
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting products for category {CategoryId}", categoryId);
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Search products by name (Admin view)
        /// </summary>
        [HttpGet("search")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> SearchProducts([FromQuery] string searchTerm)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(searchTerm))
                {
                    return BadRequest(new { message = "Search term cannot be empty." });
                }

                var products = await _productService.GetProductsByNameAsync(searchTerm);
                return Ok(new
                {
                    products,
                    searchTerm,
                    count = products.Count()
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error searching products with term {SearchTerm}", searchTerm);
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get products filtered by multiple criteria
        /// </summary>
        [HttpPost("filter")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> FilterProducts([FromBody] ProductFilterDto filter)
        {
            try
            {
                var products = await _productService.FilterProductsAsync(filter);
                return Ok(new
                {
                    products = products.Select(p => new ProductDto
                    {
                        Id = p.Id,
                        Name = p.Name,
                        Description = p.Description,
                        Price = p.Price,
                        Stock = p.StockQuantity,
                        CategoryId = p.CategoryId,
                        CategoryName = p.Category?.Name,
                        ImageUrl = p.ImageUrl,
                        CreatedAt = p.CreatedAt,
                        Size = string.IsNullOrEmpty(p.Size) ? null : p.Size.Split(',').ToList(),
                        AgeGroups = string.IsNullOrEmpty(p.AgeGroup) ? null : p.AgeGroup.Split(',').ToList(),
                        Materials = string.IsNullOrEmpty(p.Material) ? null : p.Material.Split(',').ToList(),
                        Colors = string.IsNullOrEmpty(p.Colors) ? null : p.Colors.Split(',').ToList(),
                        FinalPrice = p.Discount != null && p.Discount.Percentage.HasValue && p.Discount.Percentage.Value > 0 
                            ? Math.Max(0, p.Price - (p.Price * p.Discount.Percentage.Value / 100m))
                            : p.Price,
                        DiscountPercantage = p.Discount?.Percentage ?? 0m
                    }),
                    filter,
                    count = products.Count
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error filtering products");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get products sorted by price (Admin view)
        /// </summary>
        [HttpGet("sorted/price")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsSortedByPrice([FromQuery] bool ascending = true)
        {
            try
            {
                var products = await _productService.GetProductsSortedByPriceAsync(ascending);
                return Ok(new
                {
                    products,
                    sortOrder = ascending ? "ascending" : "descending",
                    sortBy = "price"
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting products sorted by price");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get products sorted by creation date (Admin view)
        /// </summary>
        [HttpGet("sorted/date")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsSortedByDate([FromQuery] bool ascending = false)
        {
            try
            {
                var products = await _productService.GetProductsSortedByDateAsync(ascending);
                return Ok(new
                {
                    products,
                    sortOrder = ascending ? "ascending" : "descending",
                    sortBy = "createdAt"
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting products sorted by date");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get available products (in stock)
        /// </summary>
        [HttpGet("available")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetAvailableProducts()
        {
            try
            {
                var products = await _productService.GetAvailableProductsAsync();
                return Ok(new
                {
                    products,
                    count = products.Count(),
                    filter = "available_only"
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting available products");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get latest products
        /// </summary>
        [HttpGet("latest")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetLatestProducts([FromQuery] int count = 10)
        {
            try
            {
                if (count < 1 || count > 100)
                {
                    return BadRequest(new { message = "Count must be between 1 and 100." });
                }

                var products = await _productService.GetLatestProductsAsync(count);
                return Ok(new
                {
                    products,
                    requestedCount = count,
                    actualCount = products.Count()
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting latest products");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Check if product is available (has stock)
        /// </summary>
        [HttpGet("{id}/availability")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<object>> CheckProductAvailability(int id)
        {
            try
            {
                var isAvailable = await _productService.IsProductAvailableAsync(id);
                var product = await _productService.GetProductByIdAsync(id);

                return Ok(new
                {
                    productId = id,
                    isAvailable,
                    stock = product.Stock,
                    productName = product.Name
                });
            }
            catch (KeyNotFoundException)
            {
                return NotFound(new { message = $"Product with ID {id} not found." });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error checking availability for product {ProductId}", id);
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get product statistics (Admin only)
        /// </summary>
        [HttpGet("statistics")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<object>> GetProductStatistics()
        {
            try
            {
                var totalProducts = await _productService.GetProductCountAsync();
                var availableProducts = await _productService.GetAvailableProductsAsync();
                var allProducts = await _productService.GetAllProductsAsync();

                var outOfStockCount = allProducts.Count(p => p.Stock == 0);
                var lowStockCount = allProducts.Count(p => p.Stock > 0 && p.Stock <= 5);

                return Ok(new
                {
                    totalProducts,
                    availableProducts = availableProducts.Count(),
                    outOfStockProducts = outOfStockCount,
                    lowStockProducts = lowStockCount,
                    averagePrice = allProducts.Any() ? allProducts.Average(p => p.Price) : 0,
                    highestPrice = allProducts.Any() ? allProducts.Max(p => p.Price) : 0,
                    lowestPrice = allProducts.Any() ? allProducts.Min(p => p.Price) : 0
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting product statistics");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        /// <summary>
        /// Get products by price range (Admin view)
        /// </summary>
        [HttpGet("price-range")]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsByPriceRange(
            [FromQuery] decimal minPrice, 
            [FromQuery] decimal maxPrice)
        {
            try
            {
                if (minPrice < 0 || maxPrice < 0 || minPrice > maxPrice)
                {
                    return BadRequest(new { message = "Invalid price range." });
                }

                var products = await _productService.GetProductsByPriceRangeAsync(minPrice, maxPrice);
                return Ok(new
                {
                    products,
                    priceRange = new { minPrice, maxPrice },
                    count = products.Count()
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting products by price range");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}