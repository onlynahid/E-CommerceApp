using AYYUAZ.APP.Application.Dtos;
using AYYUAZ.APP.Application.Interfaces;
using AYYUAZ.APP.Attributes;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
namespace AYYUAZ.APP.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ProductController : ControllerBase
    {
        private readonly IProductService _productService;
        public ProductController(IProductService productService)
        {
            _productService = productService;
        }
        [HttpGet]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetAllProducts()
        {
            var products = await _productService.GetAllProductsAsync();
            return Ok(products);
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<ProductDto>> GetProductById(int id)
        {
            try
            {
                var product = await _productService.GetProductByIdAsync(id);
                return Ok(product);
            }
            catch (KeyNotFoundException)
            {
                return NotFound($"Product with ID {id} not found.");
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "An error occurred while retrieving the product.", details = ex.Message });
            }
        }

        [HttpGet("category/{categoryId}")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsByCategory(int categoryId)
        {
            var products = await _productService.GetProductsByCategoryAsync(categoryId);
            return Ok(products);
        }
        [HttpGet("search")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> SearchProducts([FromQuery] string searchTerm)
        {
            if (string.IsNullOrEmpty(searchTerm))
            {
                return BadRequest("Search term cannot be empty.");
            }

            var products = await _productService.GetProductsByNameAsync(searchTerm);
            return Ok(products);
        }
        [HttpGet("price-range")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsByPriceRange([FromQuery] decimal minPrice, [FromQuery] decimal maxPrice)
        {
            if (minPrice < 0 || maxPrice < 0 || minPrice > maxPrice)
            {
                return BadRequest("Invalid price range.");
            }

            var products = await _productService.GetProductsByPriceRangeAsync(minPrice, maxPrice);
            return Ok(products);
        }
        [HttpGet("paged")]
        public async Task<ActionResult<object>> GetProductsWithPagination([FromQuery] int page = 1, [FromQuery] int pageSize = 10)
        {
            if (page < 1 || pageSize < 1)
            {
                return BadRequest("Page and page size must be greater than 0.");
            }

            var products = await _productService.GetProductsWithPaginationAsync(page, pageSize);
            var totalcount = await _productService.GetProductCountAsync();

            return Ok(new
            {
                products,
                totalcount,
                currentPage = page,
                pageSize,
                totalPages = (int)Math.Ceiling((double)totalcount / pageSize)
            });
        }
        [HttpGet("available")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetAvailableProducts()
        {
            var products = await _productService.GetAvailableProductsAsync();
            return Ok(products);
        }
        [HttpGet("latest")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetLatestProducts([FromQuery] int count = 10)
        {
            var products = await _productService.GetLatestProductsAsync(count);
            return Ok(products);
        }
        [HttpGet("sorted-by-price")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsSortedByPrice([FromQuery] bool ascending = true)
        {
            var products = await _productService.GetProductsSortedByPriceAsync(ascending);
            return Ok(products);
        }
        [HttpGet("{id}/availability")]
        public async Task<ActionResult<bool>> CheckProductAvailability(int id)
        {
            var isAvailable = await _productService.IsProductAvailableAsync(id);
            return Ok(new { productId = id, isAvailable });
        }
        [HttpPost("filter")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> FilterProducts([FromBody] ProductFilterDto filter)
        {
            try
            {
                if (filter == null)
                {
                    return BadRequest("Filter criteria cannot be null.");
                }

                // Validate price range
                if (filter.MinPrice.HasValue && filter.MaxPrice.HasValue && filter.MinPrice > filter.MaxPrice)
                {
                    return BadRequest("Minimum price cannot be greater than maximum price.");
                }

                if (filter.MinPrice < 0 || filter.MaxPrice < 0)
                {
                    return BadRequest("Price values cannot be negative.");
                }

                var filteredProducts = await _productService.FilterProductsAsync(filter);
                var productDtos = filteredProducts.Select(p => new ProductDto
                {
                    Id = p.Id,
                    Name = p.Name,
                    Description = p.Description,
                    Price = p.Price,
                    Stock = p.StockQuantity,
                    CategoryId = p.CategoryId,
                    CategoryName = p.Category?.Name ?? "",
                    ImageUrl = p.ImageUrl,
                    CreatedAt = p.CreatedAt,
                    AgeGroups = string.IsNullOrEmpty(p.AgeGroup) ? null : p.AgeGroup.Split(',').ToList(),
                    Materials = string.IsNullOrEmpty(p.Material) ? null : p.Material.Split(',').ToList(),
                    Size = string.IsNullOrEmpty(p.Size) ? null : p.Size.Split(',').ToList(),
                    Colors = string.IsNullOrEmpty(p.Colors) ? null : p.Colors.Split(',').ToList()
                }).ToList();
                return Ok(new
                {
                    products = productDtos,
                    totalCount = productDtos.Count,
                    appliedFilters = new
                    {
                        ageGroups = filter.AgeGroups,
                        materials = filter.Materials,
                        sizes = filter.Size,
                        colors = filter.Colors,
                        minPrice = filter.MinPrice,
                        maxPrice = filter.MaxPrice
                    },
                    debugInfo = new
                    {
                        receivedFilter = filter,
                        rawProductsCount = filteredProducts.Count
                    }
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "An error occurred while filtering products.", details = ex.Message });
            }
        }
        [HttpPost("test-filter")]
        public async Task<ActionResult> TestFilterLogic([FromBody] ProductFilterDto filter)
        {
            try
            {
                var filteredProducts = await _productService.FilterProductsAsync(filter);
                
                return Ok(new
                {
                    message = "Test filter results",
                    filterCriteria = new
                    {
                        sizes = filter.Size,
                        ageGroups = filter.AgeGroups,
                        materials = filter.Materials,
                        colors = filter.Colors,
                        minPrice = filter.MinPrice,
                        maxPrice = filter.MaxPrice
                    },
                    resultsCount = filteredProducts.Count,
                    firstFewResults = filteredProducts.Take(3).Select(p => new
                    {
                        id = p.Id,
                        name = p.Name,
                        rawSize = p.Size,
                        rawAgeGroup = p.AgeGroup,
                        rawMaterial = p.Material,
                        rawColors = p.Colors,
                        price = p.Price
                    }).ToList()
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "Test filter error", details = ex.Message });
            }
        }
        [HttpGet("debug/all-sizes")]
        public async Task<ActionResult> GetAllSizesForDebug()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                var sizes = products
                    .Where(p => !string.IsNullOrEmpty(p.Size?.FirstOrDefault()))
                    .SelectMany(p => p.Size ?? new List<string>())
                    .Distinct()
                    .OrderBy(s => s)
                    .ToList();

                return Ok(new
                {
                    message = "All unique sizes in database",
                    sizes = sizes,
                    totalProducts = products.Count(),
                    productsWithSizes = products.Count(p => p.Size != null && p.Size.Any())
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "Debug error", details = ex.Message });
            }
        }
        [HttpGet("debug/all-data")]
        public async Task<ActionResult> GetAllDataForDebug()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                var productDetails = products.Take(5).Select(p => new
                {
                    id = p.Id,
                    name = p.Name,
                    sizeRaw = p.Size?.FirstOrDefault(), // First item from the Size list
                    sizeList = p.Size, // Full Size list after splitting
                    sizesCount = p.Size?.Count ?? 0,
                    ageGroupRaw = p.AgeGroups?.FirstOrDefault(),
                    ageGroupList = p.AgeGroups,
                    materialsRaw = p.Materials?.FirstOrDefault(),
                    materialsList = p.Materials,
                    colorsRaw = p.Colors?.FirstOrDefault(),
                    colorsList = p.Colors
                }).ToList();

                return Ok(new
                {
                    message = "Raw data from first 5 products",
                    totalProducts = products.Count(),
                    sampleProducts = productDetails,
                    allUniqueSizes = products
                        .Where(p => p.Size != null && p.Size.Any())
                        .SelectMany(p => p.Size)
                        .Distinct()
                        .OrderBy(s => s)
                        .ToList()
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "Debug error", details = ex.Message });
            }
        }
        [HttpGet("debug/raw-database")]
        public async Task<ActionResult> GetRawDatabaseData()
        {
            try
            {
                // Get raw Product entities directly from service (they will be mapped to DTOs)
                // We need to get raw data from database
                var filteredProducts = await _productService.FilterProductsAsync(new ProductFilterDto());
                
                var rawData = filteredProducts.Take(5).Select(p => new
                {
                    id = p.Id,
                    name = p.Name,
                    sizeRaw = p.Size,         // Raw Size string from database
                    ageGroupRaw = p.AgeGroup, // Raw AgeGroup string from database  
                    materialRaw = p.Material, // Raw Material string from database
                    colorsRaw = p.Colors      // Raw Colors string from database
                }).ToList();

                return Ok(new
                {
                    message = "Raw database fields from first 5 products",
                    totalProducts = filteredProducts.Count,
                    sampleRawProducts = rawData
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "Debug error", details = ex.Message });
            }
        }
    }
}